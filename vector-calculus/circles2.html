<html>
<title>Harmonics</title>
<head>
  <style href="./main.css"></style>
  <script src="lib/math.min.js"></script>
  <script src="lib/dat.gui.min.js"></script>
  <style>
    html, body {
      background-color: #303035;
      text-align: center;
      vertical-align: middle;
      padding: 0;
      margin: 0;
      overflow: hidden;
      height: 100%;
      width: 100%;
    }

    /*
    canvas {
      margin: auto;
      user-select: none !important;
      -moz-user-select: none !important;
      -ms-user-select: none !important;
      -webkit-user-select: none !important;
      pointer-events: none;
    }
     */
    .dg .c .slider-fg {
      background-color: #808080 !important;
    }

    .dg .cr.number, .dg .cr.boolean {
      border-left: 3px solid #808080;
    }

    .dg .cr.number input[type=text] {
      color: #808080;
    }
  </style>
</head>
<body>
<script type="module">
    import * as THREE from './lib/three.module.js';
    import { colorsGrey, rainbow } from './colors.js';
    import { getMaterial, drawAxis, makeCircle, buildScene, resize } from './threetools.js';

    function onResize() {
        resize(sceneInfo.renderer, sceneInfo.camera, window.innerWidth, window.innerHeight);
    }

    function drawCircles(radius, ngon) {
        sceneInfo.clear();
        const depth = gui.controllers.ctrlDepth.getValue();
        const pivot = new THREE.Vector3(0, 0, 0);
        const materialDistance = Math.floor((rainbow.length - 1) / depth);
        for (let i = 0; i < depth; i++) {
            const circle = makeCircle(pivot, i * 2.5 * radius, 0, radius, ngon, 0, getMaterial(rainbow, i * materialDistance));
            sceneInfo.addObject(circle);
        }
        sceneInfo.render();
    }

    /**
     * animate objects per frame
     */
    function updateObjects() {
        if (sceneInfo.hasChanged) {
            sceneInfo.hasChanged = doLoopIm(sceneInfo.objects, gui.controllers.ctrlLoopIm.getValue(), gui.controllers.ctrlLoopImSpeed.getValue());
            sceneInfo.scale(gui.controllers.ctrlScale.getValue());
        }
    }

    function animationLoop() {
        sceneInfo.animationLoopId = requestAnimationFrame(animationLoop);
        updateObjects();
        sceneInfo.render();
    }

    function doLoopIm(objects, doLoop, angle) {
        let didChange = false;
        if (doLoop) {
            objects.forEach((circle, index) => {
                // ... rotateByAngle(circle, angle);
            });
            didChange = true;
        }
        return didChange;
    }

    function popGui(gui) {
        gui.options.load = gui.parameters;
        const datGui = new dat.GUI(gui.options);
        gui.controllers.ctrlLoopIm = datGui.add(gui.parameters, 'Loop Im', false, true).onChange(() => {
            sceneInfo.hasChanged = true;
        });
        gui.controllers.ctrlLoopImSpeed = datGui.add(gui.parameters, 'Loop Im Speed', 0, 5).onChange(() => {
            sceneInfo.hasChanged = true;
        });
        gui.controllers.ctrlScale = datGui.add(gui.parameters, 'Scale', 0, 2, 0.05).onChange(() => {
            sceneInfo.hasChanged = true;
        });
        gui.controllers.ctrlDepth = datGui.add(gui.parameters, 'Depth', 1, 10, 1).onFinishChange(drawCircles);
    }

    const gui = {
        options: {name: 'Parameter GUI', autoPlace: true, hideable: true, closed: false, closeOnTop: false},
        controllers: {
            ctrlLoopIm: null,
            ctrlLoopImSpeed: null,
            ctrlScale: null,
            ctrlDepth: null
        },
        parameters: {
            'Loop Im': true,
            'Loop Im Speed': 1,
            'Scale': 0.3,
            'Depth': 6,
        }
    };

    const sceneInfo = buildScene(document.body, window.innerWidth, window.innerHeight, 3, 0x303035, 0xffffff);

    window.addEventListener("resize", onResize);

    popGui(gui);
    drawAxis(sceneInfo.scene, 40, getMaterial(colorsGrey, 1));

    drawCircles(2, 16);
    sceneInfo.scale(gui.controllers.ctrlScale.getValue());

    animationLoop();
    sceneInfo.hasChanged = doLoopIm(sceneInfo.objects, gui.controllers.ctrlLoopIm.getValue(), gui.controllers.ctrlLoopImSpeed.getValue());

</script>

</body>
</html>
